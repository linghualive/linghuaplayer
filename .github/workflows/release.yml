name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux bundle in Docker
        run: |
          docker build -t flamekit-linux -f Dockerfile.linux .
          docker run --rm -v "$PWD:/app" flamekit-linux bash -c "
            flutter pub get &&
            flutter build linux --release
          "

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package tar.gz
        run: |
          cd build/linux/x64/release/bundle
          tar czf "$GITHUB_WORKSPACE/flamekit-linux-x64.tar.gz" .

      - name: Package deb
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG="flamekit_${VERSION}_amd64"
          mkdir -p "$PKG/DEBIAN"
          mkdir -p "$PKG/usr/lib/flamekit"
          mkdir -p "$PKG/usr/bin"
          mkdir -p "$PKG/usr/share/applications"
          mkdir -p "$PKG/usr/share/icons/hicolor/256x256/apps"
          cp -r build/linux/x64/release/bundle/* "$PKG/usr/lib/flamekit/"
          printf '#!/bin/bash\nexec /usr/lib/flamekit/flamekit "$@"\n' > "$PKG/usr/bin/flamekit"
          chmod 755 "$PKG/usr/bin/flamekit"
          cp linux/packaging/flamekit.desktop "$PKG/usr/share/applications/"
          cp logo.png "$PKG/usr/share/icons/hicolor/256x256/apps/flamekit.png"
          INSTALLED_SIZE=$(du -sk "$PKG/usr" | awk '{print $1}')
          cat > "$PKG/DEBIAN/control" << EOF
          Package: flamekit
          Version: $VERSION
          Architecture: amd64
          Installed-Size: $INSTALLED_SIZE
          Maintainer: linghualive <linghualive@users.noreply.github.com>
          Depends: libgtk-3-0 | libgtk-3-0t64, libmpv2 | libmpv1
          Section: sound
          Priority: optional
          Description: Multi-source Music Player
           使用 Flutter 开发的多源音乐播放器
          EOF
          dpkg-deb --build --root-owner-group "$PKG"
          mv "${PKG}.deb" flamekit-linux-x64.deb

      - name: Package pacman
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          docker run --rm -v "$PWD:/workspace" archlinux:latest \
            bash /workspace/linux/packaging/build-pacman.sh "$VERSION"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            flamekit-linux-x64.tar.gz
            flamekit-linux-x64.deb
            flamekit-linux-x64.pkg.tar.zst

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build macOS app
        run: flutter build macos --release

      - name: Package artifact
        run: |
          cd build/macos/Build/Products/Release
          zip -r "$GITHUB_WORKSPACE/flamekit-macos.zip" flamekit.app

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: flamekit-macos.zip
